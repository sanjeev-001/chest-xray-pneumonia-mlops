name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-python-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
        
    - name: Update requirements.txt
      run: |
        # Create requirements.in if it doesn't exist
        if [ ! -f requirements.in ]; then
          cp requirements.txt requirements.in
        fi
        
        # Update dependencies
        pip-compile --upgrade requirements.in
        
    - name: Update requirements-dev.txt
      run: |
        # Create requirements-dev.in if it doesn't exist
        if [ ! -f requirements-dev.in ]; then
          cp requirements-dev.txt requirements-dev.in
        fi
        
        # Update dev dependencies
        pip-compile --upgrade requirements-dev.in
        
    - name: Test updated dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
        # Run smoke tests to ensure dependencies work
        python -c "
        import sys
        try:
            import torch
            import torchvision
            import numpy
            import pandas
            import sklearn
            import mlflow
            import pytest
            print('âœ… All critical dependencies imported successfully')
        except ImportError as e:
            print(f'âŒ Dependency import failed: {e}')
            sys.exit(1)
        "
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Python dependencies'
        title: 'chore: update Python dependencies'
        body: |
          ## Automated Dependency Update
          
          This PR updates Python dependencies to their latest compatible versions.
          
          ### Changes
          - Updated `requirements.txt` with latest package versions
          - Updated `requirements-dev.txt` with latest development dependencies
          
          ### Testing
          - âœ… Smoke tests passed for critical dependencies
          - âœ… Import tests successful
          
          ### Review Notes
          Please review the changes and run the full test suite before merging.
          
          Auto-generated by GitHub Actions on $(date)
        branch: dependency-updates/python-packages
        delete-branch: true
        labels: |
          dependencies
          automated
          
  update-github-actions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update GitHub Actions
      uses: renovatebot/github-action@v39.2.3
      with:
        configurationFile: .github/renovate.json
        token: ${{ secrets.GITHUB_TOKEN }}
        
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety pip-audit
        
    - name: Run security audit
      run: |
        echo "# Security Audit Report" > security-audit-report.md
        echo "Generated: $(date)" >> security-audit-report.md
        echo "" >> security-audit-report.md
        
        echo "## Safety Check Results" >> security-audit-report.md
        echo "\`\`\`" >> security-audit-report.md
        safety check --output text >> security-audit-report.md || echo "Safety check completed with warnings" >> security-audit-report.md
        echo "\`\`\`" >> security-audit-report.md
        echo "" >> security-audit-report.md
        
        echo "## Pip Audit Results" >> security-audit-report.md
        echo "\`\`\`" >> security-audit-report.md
        pip-audit --output text >> security-audit-report.md || echo "Pip audit completed with warnings" >> security-audit-report.md
        echo "\`\`\`" >> security-audit-report.md
        
    - name: Create security audit issue
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = fs.readFileSync('security-audit-report.md', 'utf8');
            
            // Check if there's already an open security audit issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security-audit',
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Weekly Security Audit Report - ${new Date().toISOString().split('T')[0]}`,
                body: report,
                labels: ['security-audit', 'automated']
              });
            } else {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: report
              });
            }
          } catch (error) {
            console.log('Could not create/update security audit issue:', error);
          }